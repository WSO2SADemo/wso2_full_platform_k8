name: Integration - Mock Backends

on:
  push:
    paths:
      # 1. CORRECTED: Trigger on changes within the new source directory
      - 'apim-integration-artefacts-for-cicd-pipeline/integration/integrations-2/mock_backends/**'
      - '.github/workflows/mock_backends-ci.yml'
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      BALLERINA_NAMESPACE: ballerina 
      PROJECT_DIR: apim-integration-artefacts-for-cicd-pipeline/integration/integrations-2/mock_backends

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Print Ballerina Version
        run: bal version

      - name: Build Ballerina Project (Generates K8s artifacts)
        working-directory: ${{ env.PROJECT_DIR }}
        run: bal build
      
      - name: üîê Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Push Docker Image
        run: |
          # Ensure this image name matches what is in your Ballerina generated YAML
          IMAGE_NAME="ramilu90/mock_backend:latest"
          docker push ${IMAGE_NAME}

      - name: Ensure Namespace Exists
        run: |
          # Uses your local kubectl context automatically
          kubectl create namespace ${{ env.BALLERINA_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: üîç Debug - Check K8s Artifacts Directory
        run: |
          # K8s artifacts path relative to repository root
          K8S_ARTIFACTS_DIR="${{ env.PROJECT_DIR }}/target/kubernetes/mock_backends"
          
          if [ -d "${K8S_ARTIFACTS_DIR}" ]; then
            echo "${K8S_ARTIFACTS_DIR} directory exists. Contents:"
            ls -la ${K8S_ARTIFACTS_DIR}
          else
            echo "Error: ${K8S_ARTIFACTS_DIR} directory does NOT exist after build."
            exit 1
          fi

      - name: Create ConfigMap
        run: |
          NAMESPACE="${{ env.BALLERINA_NAMESPACE }}"
          
          # Create the ConfigMap YAML file on the fly
          cat <<EOF > configmap.yaml
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: ballerina-values-mock-backends
            namespace: $NAMESPACE
          data:
            BAL_CONFIG_VAR_BALLERINAX_WSO2_CONTROLPLANE_NODEID: "mock_backends"
            BAL_CONFIG_DATA: ' [ballerinax.wso2.controlplane.dashboard] \n url="https://cloud-wso2-icp.icp.svc.cluster.local:9743/dashboard/api" \n heartbeatInterval=10 \n groupId="cluster1" \n mgtApiUrl="https://mock-backends.ballerina.svc.cluster.local:9264/management/" \n nodeId="mock_backends" '
          EOF

          # Apply it to the cluster
          kubectl apply -f configmap.yaml

      - name: Deploy Kubernetes Resources
        run: |
          K8S_DIR="${{ env.PROJECT_DIR }}/target/kubernetes/mock_backends"
          echo "Applying resources to Local Cluster..."
          kubectl apply -f ${K8S_DIR} -n ${{ env.BALLERINA_NAMESPACE }}

  # -----------------------------------------------------------
      # ‚ûï NEW STEP: Manually create the Service (since it's missing)
      # -----------------------------------------------------------
      - name: Create Service Manually
        run: |
          NAMESPACE="${{ env.BALLERINA_NAMESPACE }}"
          DEPLOYMENT="mock-backends-deployment"
          SERVICE_NAME="mock-backends"  # (Hyphens only!)

          # check if service exists, if not create it
          if ! kubectl get svc $SERVICE_NAME -n $NAMESPACE > /dev/null 2>&1; then
             echo "Service not found. Creating it now..."
             kubectl expose deployment $DEPLOYMENT -n $NAMESPACE --name=$SERVICE_NAME --port=9092 --target-port=9092 --type=ClusterIP
          else
             echo "Service $SERVICE_NAME already exists."
          fi

      # -----------------------------------------------------------
      # ‚úèÔ∏è UPDATED STEP: Patch using the CORRECT Service Name
      # -----------------------------------------------------------
      - name: Patch Deployment (Volume Mounts)
        run: |
          NAMESPACE="${{ env.BALLERINA_NAMESPACE }}"
          DEPLOYMENT="mock-backends-deployment"
          SERVICE_NAME="mock-backends" # MUST match the step above (hyphens)
          
          # Wait for deployment
          kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=60s || true

          # Get Container Name
          CONTAINER_NAME=$(kubectl get deployment $DEPLOYMENT -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].name}')
          
          # Patch Service Ports (Using the valid hyphenated name)
          kubectl patch svc $SERVICE_NAME -n $NAMESPACE --type='json' -p='[{"op": "add", "path": "/spec/ports/-", "value": {"name": "management", "port": 9264, "targetPort": 9264, "protocol": "TCP"}}]' || true
          
          # Patch Volumes
          kubectl patch deployment $DEPLOYMENT -n $NAMESPACE --patch "
          spec:
            template:
              spec:
                volumes:
                - name: keystore-vol
                  secret:
                    secretName: ballerina-integration-secret
                containers:
                - name: $CONTAINER_NAME
                  volumeMounts:
                  - name: keystore-vol
                    mountPath: /home/ballerina/bre/security
                    readOnly: true
          "
          
          echo "Patch applied. Verifying..."
          kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE